#!/bin/bash
export SELF="$0"
export CCACHE_DISABLE=1

if [ `uname` = Darwin ]; then
    ABSPATH='realpath'
else
    ABSPATH='readlink -f'
fi

usage() {
    echo Usage: $0 SRC COMPILE_ARGS
    exit 1
}

die() {
    printf "%s: %s\n" "$SELF" "$*" >&2
    exit 1
}

# include common code base
topdir="`dirname "$(${ABSPATH} "$SELF")"`/.."

export SINK="/dev/null"
export COMPILE_OPTS="-S -c -O0 -I$topdir/include/predator-builtins -DPREDATOR"
export JSON_PLUG='@JSON_PLUG@'
export ENABLE_LLVM='@ENABLE_LLVM@'
if [ -z $ENABLE_LLVM ]; then
    export GCC_HOST='@GCC_HOST@'
else
    export OPT_HOST='@OPT_HOST@'
    export CLANG_HOST='@CLANG_HOST@'
fi

seek_input_file() {
    for i in "$@"; do
        test -e "$i" && SRC="$(basename $i)" && return 0
    done

    return 1
}

seek_input_file "$@" || usage

# run the gcc
run_gcc() {
    "$GCC_HOST" $COMPILE_OPTS -o $SINK -fplugin="$JSON_PLUG" "$@" \
        -fplugin-arg-libjson-gen-dot="$SRC.dot" -fplugin-arg-libjson-dry-run
}

# run the clang/LLVM
run_llvm() {
    "$CLANG_HOST" $COMPILE_OPTS -emit-llvm -g -o -         \
        -Xclang -fsanitize-address-use-after-scope "$@"    \
        | "$OPT_HOST" -o $SINK                             \
        -lowerswitch                                       \
        -load "$JSON_PLUG" -json -gen-dot="$SRC.dot" -dry-run
}

if [ -z $ENABLE_LLVM ]; then
    run_gcc "$@"
else
    run_llvm "$@"
fi

which dot > /dev/null || die "dot is not installed"

# convert dots to svgs
for i in $SRC*.dot; do
    fn=`basename $i`
    j="${fn%.*}"
    dot -Tsvg < $i > $j.svg
    rm $i
done

URL="$SRC.svg"

# open svg
if [ `uname` = Darwin ]; then
    if open -Ra "Firefox" ; then
        open -a Firefox "$URL"
    elif open -Ra "Safari" ; then
        open -a Safari "$URL"
    else
        die "Can't find any SVG browser. The file to open: $URL"
    fi
else
    if [ -x "$BROWSER" ]; then
        path="$BROWSER"
    else
        path=$(which xdg-open || which gnome-open)
    fi
    [[ -z "$path" ]] && die "Can't find any SVG browser. The file to open: $URL"
    exec "$path" "$URL" &
fi
